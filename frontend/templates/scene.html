<!DOCTYPE html>
<html lang="en" style="overflow-x: hidden;">
<head>
	<meta charset="UTF-8">
	<title>Real-Time Packet Sniffer</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Antonio:wght@400;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles/LCARS/lcars-colors.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles/LCARS/lcars-ultra-picard.css') }}" rel="stylesheet">
    <script src="{{ url_for('static', filename='styles/LCARS/jquery-3-7-0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='styles/LCARS/lcars.js') }}"></script>
	<script src="https://kit.fontawesome.com/9d35a24d36.js" crossorigin="anonymous"></script>
    <link href="{{ url_for('static', filename='styles/main.css') }}" rel="stylesheet">
</head>
<body>
	
<div class="card col-12">

	<div class="card-header">Virtual Desk</div>

	<div class="card-body col-12">

		<div class="fixtures-container col-12" id="fixtures-container" style="max-width: unset;"></div>

	</div>

</div>

</body>

<script>
	window.onload = function() {
		fetchFixtures();
	};

	async function fetchFixtures() {
        const response = await fetch(`/api/availableFixtures`);
        const fixtures = await response.json();

        fixtures.forEach(fixture => {

			if (fixture.type.includes("Colorspot575XT")) {
				console.log("Colorspot 575 XT found with name: " + fixture.name); 
			}
			else if (fixture.type.includes("Colorspot250AT")) {
				console.log("Colorspot 250 AT found with ID: " + fixture.name);
			}
			else if (fixture.type.includes("Colorwash250AT")) {
				console.log("Colorwash 250 AT found with ID: " + fixture.name);
			}
			else if (fixture.type.includes("Dimmer")) {
				console.log("Dimmer found with ID: " + fixture.name);
			}

			const container = document.getElementById('fixtures-container');

			const fixtureDiv = document.createElement('div');
			fixtureDiv.className = `fixture`;
			fixtureDiv.id = `fixture-${fixture.id}`;

			const fixtureContainer = document.createElement('div');
			fixtureContainer.className = 'fixtureContainer';

			const fixtureTitle = document.createElement('h1');
			fixtureTitle.className = "title";
			fixtureTitle.textContent = fixture.name;

			container.appendChild(fixtureDiv);
			fixtureDiv.appendChild(fixtureTitle);


			Object.entries(fixture.attributes)
	.map(([key, { DMXValue, index, value }]) => ({ key, DMXValue, index, value }))
	.sort((a, b) => a.index - b.index) 
		.forEach(({ key, value, DMXValue }) => {
			console.log(`DMXVal: ${DMXValue}, Attribute: ${key}`, value);

			const attributeName = key;

			const slider = document.createElement('input');
			slider.type = 'range';
			slider.min = 0;
			slider.max = 255;
			slider.value = DMXValue;
			slider.className = 'slider';
			slider.id = `slider-${fixture.name}-${attributeName}`;
			slider.oninput = function() {
				updateDMXValue(attributeName, fixture.name, this.value);
				valueLabel.textContent = this.value;
			};

			const valueLabel = document.createElement('label');
			valueLabel.className = 'valueLabel';
			valueLabel.id = `valueLabel-${fixture.name}-${attributeName}`; 
			valueLabel.textContent = DMXValue; 

			const createLabelOrImage = (name) => {
				const img = new Image();
				img.src = `/static/images/channelImageStore/${name.toLowerCase()}.svg`;
				img.className = 'attributeIcon';

				// Fallback to label if image doesn't exist
				img.onerror = () => {
					const fallbackLabel = document.createElement('label');
					fallbackLabel.className = 'label';
					fallbackLabel.textContent = name;
					fixtureChannel.appendChild(fallbackLabel);
				};

				img.onload = () => {
					fixtureChannel.appendChild(img);
				};
			};
			
			const fixtureChannel = document.createElement('div');
			fixtureChannel.className = 'fixtureChannel';
			fixtureChannel.id = `fixtureChannel-${fixture.name}-${attributeName}`; 

			fixtureChannel.appendChild(slider);
			createLabelOrImage(attributeName);
			fixtureChannel.appendChild(valueLabel);
			fixtureContainer.appendChild(fixtureChannel);
			fixtureDiv.appendChild(fixtureContainer);
		});

	});
    }

    function updateDMXValue(attributeName, fixtureName, value) {
        console.log(`Fixture ID: ${fixtureName}, DMX Value: ${value}`);

		socket.emit('UpdateDMXValue', {"fixtureName": fixtureName, "attributeName": attributeName, "value": value});
    }
	
	var socket = io.connect('http://' + window.location.hostname + ':8080', {transports: ['websocket']});

	socket.on('connect', function() {

		$("#warningsContainer").css("display", "none");
		
		console.log("Client connected!");
	});


	socket.on('UpdateDMXValue', function(data) {
		console.log("Updating DMX Value: ", data)
	
		var channel = data.message.channel;
		var value = data.message.value;
		var fixture = data.message.fixture;
	
		var valueLabel = document.getElementById(`valueLabel-${fixture}-${channel}`);
		var slider = document.getElementById(`slider-${fixture}-${channel}`);
	
		valueLabel.textContent = value;
		slider.value = value;
	});
	
	socket.on("refreshPage", function() {
		location.reload();
	});
</script>
<!-- 
<script src="{{ url_for('static', filename='scripts/socketEvents.js') }}"></script> -->

</html>